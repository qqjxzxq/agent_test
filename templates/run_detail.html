<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å®æ—¶å·¥ä½œå° - {{ state.issue.title }}</title>
  <link rel="stylesheet" href="/static/style.css">
  <script src="https://unpkg.com/htmx.org@1.9.10"></script>
  <script src="https://unpkg.com/htmx.org/dist/ext/sse.js"></script>
</head>

<body>
  {% set status_map = {
  "pending": "å¾…å¤„ç†",
  "running": "è¿è¡Œä¸­",
  "completed": "å·²å®Œæˆ",
  "failed": "å¤±è´¥"
  } %}
  {% set stage_map = {
  "intake_issue": "è®®é¢˜è¿›å…¥",
  "departments_generate_memos": "éƒ¨é—¨å¤‡å¿˜å½•",
  "secretariat_aggregate_disputes": "æ±‡æ€»åˆ†æ­§",
  "negotiation_rounds": "å¤šè½®è°ˆåˆ¤",
  "legal_review_gate": "æ³•åˆ¶é—¨ç¦",
  "fiscal_capacity_review_gate": "è´¢æ”¿é—¨ç¦",
  "workflow": "å·¥ä½œæµ",
  "decider_finalize": "æœ€ç»ˆè£å†³",
  "implementation_plan": "æ‰§è¡Œè®¡åˆ’"
  } %}
  {% set department_map = {
  "finance": "è´¢æ”¿éƒ¨",
  "legal": "æ³•åˆ¶åŠ",
  "environment": "ç¯ä¿å±€",
  "security": "å®‰å…¨éƒ¨",
  "planning": "è§„åˆ’å±€",
  "industry": "å·¥ä¿¡å±€",
  "health": "å«ç”Ÿå±€",
  "education": "æ•™è‚²å±€",
  "transport": "äº¤é€šå±€"
  } %}
  {% set severity_map = {
  "high": "é«˜",
  "medium": "ä¸­",
  "low": "ä½"
  } %}
  {% set position_map = {
  "support": "æ”¯æŒ",
  "oppose": "åå¯¹",
  "conditional": "æœ‰æ¡ä»¶æ”¯æŒ",
  "neutral": "ä¸­ç«‹"
  } %}

  <div class="container">
    <header>
      <h1>ğŸ›ï¸ {{ state.issue.title }}</h1>
      <nav>
        <a href="/">æ–°å»ºä»¿çœŸ</a>
        <a href="/runs">å†å²è®°å½•</a>
      </nav>
    </header>

    <main class="workspace">
      <!-- çŠ¶æ€æ¦‚è§ˆ -->
      <section class="status-overview">
        <div class="status-card">
          <h3>è¿è¡ŒçŠ¶æ€</h3>
          <span class="status-badge status-{{ state.run_status }}" id="runStatus">
            {{ status_map.get(state.run_status, state.run_status) }}
          </span>
        </div>
        <div class="status-card">
          <h3>å½“å‰é˜¶æ®µ</h3>
          <span id="currentStage">{{ stage_map.get(state.current_stage, state.current_stage) }}</span>
        </div>
        <div class="status-card">
          <h3>æ”¿ç­–ç‰ˆæœ¬</h3>
          <span>{{ state.policy_version }}</span>
        </div>
        <div class="status-card">
          <h3>äº‹ä»¶æ•°</h3>
          <span id="eventCount">{{ state.trace_log|length }}</span>
        </div>
      </section>

      <!-- é˜¶æ®µ Stepper -->
      <section class="stage-stepper">
        <h2>æµç¨‹é˜¶æ®µ</h2>
        <div class="stepper" id="stepper">
          {% set stages = [
          ("intake_issue", "è®®é¢˜è¿›å…¥"),
          ("departments_generate_memos", "éƒ¨é—¨å¤‡å¿˜å½•"),
          ("secretariat_aggregate_disputes", "æ±‡æ€»åˆ†æ­§"),
          ("negotiation_rounds", "å¤šè½®è°ˆåˆ¤"),
          ("legal_review_gate", "æ³•åˆ¶é—¨ç¦"),
          ("fiscal_capacity_review_gate", "è´¢æ”¿é—¨ç¦"),
          ("decider_finalize", "æœ€ç»ˆè£å†³"),
          ("implementation_plan", "æ‰§è¡Œè®¡åˆ’")
          ] %}
          {% for stage_id, stage_name in stages %}
          <div class="step {% if state.current_stage == stage_id %}active{% endif %}" data-stage="{{ stage_id }}"
            onclick="showStageDetails('{{ stage_id }}', '{{ stage_name }}')">
            <div class="step-number">{{ loop.index }}</div>
            <div class="step-label">{{ stage_name }}</div>
          </div>
          {% endfor %}
        </div>
      </section>

      <!-- ä¸»å†…å®¹åŒº -->
      <div class="content-grid">
        <!-- é˜¶æ®µè¯¦æƒ…å±•ç¤ºåŒº -->
        <section class="stage-detail-section" id="stageDetailSection" style="display: none;">
          <div class="stage-detail-header">
            <h2 id="stageDetailTitle">é˜¶æ®µè¯¦æƒ…</h2>
            <button class="btn-close" onclick="closeStageDetails()">âœ• å…³é—­</button>
          </div>
          <div id="stageDetailContent" class="stage-detail-content">
            <!-- åŠ¨æ€åŠ è½½å†…å®¹ -->
          </div>
        </section>

        <!-- æ—¶é—´çº¿ -->
        <section class="timeline-section">
          <h2>å®æ—¶æ—¶é—´çº¿</h2>
          <div class="timeline" id="timeline">
            {% for event in state.trace_log %}
            <div class="timeline-item event-{{ event.event_type }}">
              <div class="timeline-time">{{ event.timestamp.strftime('%H:%M:%S') }}</div>
              <div class="timeline-content">
                <strong>{{ stage_map.get(event.stage, event.stage) }}</strong>
                {% if event.agent_id %}
                <span class="agent-badge">
                  {% if event.agent_id == "agent_finance" %}ğŸ’° è´¢æ”¿éƒ¨
                  {% elif event.agent_id == "agent_legal" %}âš–ï¸ æ³•åˆ¶åŠ
                  {% elif event.agent_id == "agent_planning" %}ğŸ“‹ è§„åˆ’å±€
                  {% elif event.agent_id == "agent_industry" %}ğŸ­ å·¥ä¿¡å±€
                  {% elif event.agent_id == "agent_environment" %}ğŸŒ± ç¯ä¿å±€
                  {% elif event.agent_id == "agent_security" %}ğŸ”’ å®‰å…¨å±€
                  {% elif event.agent_id == "agent_office" %}ğŸ“ åŠå…¬å…
                  {% elif event.agent_id == "agent_decider" %}ğŸ‘‘ å†³ç­–è€…
                  {% else %}{{ event.agent_id }}{% endif %}
                </span>
                {% endif %}
                <p>{{ event.message }}</p>
              </div>
            </div>
            {% endfor %}
          </div>
        </section>

        <!-- è¯¦æƒ…é¢æ¿ -->
        <section class="details-panel">
          <!-- éƒ¨é—¨å¤‡å¿˜å½• -->
          <div class="panel-card">
            <h3>éƒ¨é—¨å¤‡å¿˜å½• ({{ state.memos|length }})</h3>
            <div class="tabs" id="memoTabs">
              {% for memo in state.memos %}
              <button class="tab-btn {% if loop.first %}active{% endif %}" onclick="showMemo({{ loop.index0 }})">
                {{ department_map.get(memo.department, memo.department) }}
              </button>
              {% endfor %}
            </div>
            <div class="tabs-content" id="memosContent">
              {% for memo in state.memos %}
              <div class="tab-pane {% if loop.first %}active{% endif %}" data-index="{{ loop.index0 }}">
                <div class="memo-position position-{{ memo.position }}">
                  ç«‹åœºï¼š{{ position_map.get(memo.position, memo.position) }}
                </div>
                <p><strong>ç†ç”±ï¼š</strong>{{ memo.rationale }}</p>
                <p><strong>å…³åˆ‡ç‚¹ï¼š</strong></p>
                <ul>
                  {% for concern in memo.concerns %}
                  <li>{{ concern }}</li>
                  {% endfor %}
                </ul>
                <p><strong>å»ºè®®ï¼š</strong></p>
                <ul>
                  {% for rec in memo.recommendations %}
                  <li>{{ rec }}</li>
                  {% endfor %}
                </ul>
              </div>
              {% endfor %}
            </div>
          </div>

          <!-- åˆ†æ­§ç‚¹ -->
          <div class="panel-card">
            <h3>åˆ†æ­§ç‚¹ ({{ state.disputes|length }})</h3>
            {% for dispute in state.disputes %}
            <div class="dispute-item severity-{{ dispute.severity }}">
              <h4>{{ dispute.topic }}</h4>
              <p>æ¶‰åŠéƒ¨é—¨ï¼š{% for dept in dispute.departments %}{{ department_map.get(dept, dept) }}{% if not loop.last %}ã€{%
                endif %}{% endfor %}</p>
              <p>ä¸¥é‡ç¨‹åº¦ï¼š{{ severity_map.get(dispute.severity, dispute.severity) }}</p>
              {% set dispute_status_map = {"unresolved": "æœªè§£å†³", "resolved": "å·²è§£å†³", "escalated": "å·²å‡çº§"} %}
              <span class="status-badge status-{{ dispute.status }}">{{ dispute_status_map.get(dispute.status,
                dispute.status) }}</span>
            </div>
            {% endfor %}
          </div>

          <!-- é—¨ç¦ç»“æœ -->
          <div class="panel-card">
            <h3>é—¨ç¦ç»“æœ</h3>
            {% for gate in state.gate_results %}
            <div class="gate-result {% if gate.passed %}gate-pass{% else %}gate-fail{% endif %}">
              <h4>{{ gate.gate_name }}</h4>
              <p>ç»“æœï¼š{% if gate.passed %}âœ… é€šè¿‡{% else %}âŒ æœªé€šè¿‡{% endif %}</p>
              {% if gate.issues %}
              <p><strong>é—®é¢˜ï¼š</strong></p>
              <ul>
                {% for issue in gate.issues %}
                <li>{{ issue }}</li>
                {% endfor %}
              </ul>
              {% endif %}
            </div>
            {% endfor %}
          </div>

          <!-- æœ€ç»ˆå†³ç­– -->
          {% if state.decision %}
          <div class="panel-card">
            <h3>æœ€ç»ˆå†³ç­–</h3>
            <div
              class="decision {% if state.decision.approved %}decision-approved{% else %}decision-rejected{% endif %}">
              <h4>{% if state.decision.approved %}âœ… æ‰¹å‡†{% else %}âŒ ä¸æ‰¹å‡†{% endif %}</h4>
              <p><strong>æ”¿ç­–æ–‡æœ¬ï¼š</strong></p>
              <div class="policy-text">{{ state.decision.final_policy_text }}</div>
              <p><strong>å†³ç­–ç†ç”±ï¼š</strong></p>
              <p>{{ state.decision.rationale }}</p>
              {% if state.decision.conditions %}
              <p><strong>é™„åŠ æ¡ä»¶ï¼š</strong></p>
              <ul>
                {% for cond in state.decision.conditions %}
                <li>{{ cond }}</li>
                {% endfor %}
              </ul>
              {% endif %}
            </div>
          </div>
          {% endif %}

          <!-- Agentæ´»åŠ¨ -->
          {% if state.agents %}
          <div class="panel-card">
            <h3>ğŸ¤– Agentæ´»åŠ¨ ({{ state.agents|length }})</h3>
            <div class="agents-grid">
              {% for agent_id, agent in state.agents.items() %}
              <div class="agent-card" data-agent-id="{{ agent_id }}">
                <div class="agent-header">
                  <h4>
                    {% if agent.role == "finance" %}ğŸ’° è´¢æ”¿éƒ¨
                    {% elif agent.role == "legal" %}âš–ï¸ æ³•åˆ¶åŠ
                    {% elif agent.role == "planning" %}ğŸ“‹ è§„åˆ’å±€
                    {% elif agent.role == "industry" %}ğŸ­ å·¥ä¿¡å±€
                    {% elif agent.role == "environment" %}ğŸŒ± ç¯ä¿å±€
                    {% elif agent.role == "security" %}ğŸ”’ å®‰å…¨å±€
                    {% elif agent.role == "office" %}ğŸ“ åŠå…¬å…
                    {% elif agent.role == "decider" %}ğŸ‘‘ å†³ç­–è€…
                    {% else %}{{ agent.role }}{% endif %}
                  </h4>
                  <span class="agent-status status-{{ agent.status.value }}">
                    {% if agent.status == "idle" %}å¾…æœº
                    {% elif agent.status == "observing" %}è§‚å¯Ÿä¸­
                    {% elif agent.status == "thinking" %}æ€è€ƒä¸­
                    {% elif agent.status == "acting" %}è¡ŒåŠ¨ä¸­
                    {% elif agent.status == "planning" %}è§„åˆ’ä¸­
                    {% elif agent.status == "communicating" %}é€šä¿¡ä¸­
                    {% elif agent.status == "waiting" %}ç­‰å¾…ä¸­
                    {% else %}{{ agent.status }}{% endif %}
                  </span>
                </div>
                {% if agent.position %}
                <div class="agent-position position-{{ agent.position }}">
                  ç«‹åœºï¼š{{ position_map.get(agent.position, agent.position) }}
                </div>
                {% endif %}
                {% if agent.plan and agent.plan.is_active %}
                <div class="agent-plan">
                  <strong>è§„åˆ’ï¼š</strong>{{ agent.plan.goal[:50] }}...
                  <div class="plan-steps">
                    {% for step in agent.plan.steps %}
                    <span class="step-status status-{{ step.status }}">{{ step.description[:30] }}...</span>
                    {% endfor %}
                  </div>
                </div>
                {% endif %}
                {% if agent.memory %}
                <div class="agent-memory">
                  <small>
                    è§‚å¯Ÿ: {{ agent.memory.observations|length }},
                    æ€è€ƒ: {{ agent.memory.thoughts|length }},
                    è¡ŒåŠ¨: {{ agent.memory.actions|length }},
                    æ¶ˆæ¯: {{ agent.memory.received_messages|length + agent.memory.sent_messages|length }}
                  </small>
                </div>
                {% endif %}
              </div>
              {% endfor %}
            </div>
          </div>
          
          <!-- Agentæ¶ˆæ¯é€šä¿¡ -->
          {% if state.message_queue %}
          <div class="panel-card">
            <h3>ğŸ’¬ Agentæ¶ˆæ¯é€šä¿¡ ({{ state.message_queue|length }})</h3>
            <div class="messages-list">
              {% for msg in state.message_queue[-10:] %}
              <div class="message-item">
                <div class="message-header">
                  <span class="message-from">{{ department_map.get(msg.from_agent, msg.from_agent) }}</span>
                  <span class="message-arrow">â†’</span>
                  <span class="message-to">{{ department_map.get(msg.to_agent, msg.to_agent) }}</span>
                  <span class="message-type">{{ msg.message_type.value }}</span>
                </div>
                <div class="message-content">{{ msg.content[:100] }}{% if msg.content|length > 100 %}...{% endif %}</div>
                <div class="message-time">{{ msg.timestamp.strftime('%H:%M:%S') }}</div>
              </div>
              {% endfor %}
            </div>
          </div>
          {% endif %}
          {% endif %}

          <!-- Artifacts -->
          {% if state.artifacts_index %}
          <div class="panel-card">
            <h3>äº§å‡ºæ–‡ä»¶</h3>
            <ul class="artifacts-list">
              {% for artifact in state.artifacts_index %}
              <li>
                <a href="/api/runs/{{ run_id }}/artifacts/{{ artifact.name }}" target="_blank">
                  ğŸ“„ {{ artifact.name }} ({{ (artifact.size_bytes / 1024)|round(1) }} KB)
                </a>
              </li>
              {% endfor %}
            </ul>
          </div>
          {% endif %}
        </section>
      </div>
    </main>
  </div>

  <script>
    let currentMemoIndex = 0;
    const stateData = {{ state.model_dump_json() | safe }};

    // ä¸­æ–‡æ˜ å°„
    const statusMap = {
      "pending": "å¾…å¤„ç†",
      "running": "è¿è¡Œä¸­",
      "completed": "å·²å®Œæˆ",
      "failed": "å¤±è´¥"
    };

    const stageMap = {
      "intake_issue": "è®®é¢˜è¿›å…¥",
      "departments_generate_memos": "éƒ¨é—¨å¤‡å¿˜å½•",
      "secretariat_aggregate_disputes": "æ±‡æ€»åˆ†æ­§",
      "negotiation_rounds": "å¤šè½®è°ˆåˆ¤",
      "legal_review_gate": "æ³•åˆ¶é—¨ç¦",
      "fiscal_capacity_review_gate": "è´¢æ”¿é—¨ç¦",
      "decider_finalize": "æœ€ç»ˆè£å†³",
      "implementation_plan": "æ‰§è¡Œè®¡åˆ’"
    };

    const departmentMap = {
      "finance": "è´¢æ”¿éƒ¨",
      "legal": "æ³•åˆ¶åŠ",
      "environment": "ç¯ä¿å±€",
      "security": "å®‰å…¨éƒ¨",
      "planning": "è§„åˆ’å±€",
      "industry": "å·¥ä¿¡å±€",
      "health": "å«ç”Ÿå±€",
      "education": "æ•™è‚²å±€",
      "transport": "äº¤é€šå±€"
    };

    const severityMap = {
      "high": "é«˜",
      "medium": "ä¸­",
      "low": "ä½"
    };

    const positionMap = {
      "support": "æ”¯æŒ",
      "oppose": "åå¯¹",
      "conditional": "æœ‰æ¡ä»¶æ”¯æŒ",
      "neutral": "ä¸­ç«‹"
    };

    function showMemo(index) {
      document.querySelectorAll('#memoTabs .tab-btn').forEach((btn, i) => {
        btn.classList.toggle('active', i === index);
      });
      document.querySelectorAll('#memosContent .tab-pane').forEach((pane, i) => {
        pane.classList.toggle('active', i === index);
      });
      currentMemoIndex = index;
    }

    function showStageDetails(stageId, stageName) {
      const section = document.getElementById('stageDetailSection');
      const titleEl = document.getElementById('stageDetailTitle');
      const contentEl = document.getElementById('stageDetailContent');
      let content = ''; // å£°æ˜contentå˜é‡

      // æ›´æ–°é˜¶æ®µé«˜äº®
      document.querySelectorAll('.step').forEach(step => {
        if (step.dataset.stage === stageId) {
          step.classList.add('active');
        } else {
          step.classList.remove('active');
        }
      });

      if (stageId === 'intake_issue') {
        const urgencyMap = { 'high': 'é«˜', 'medium': 'ä¸­', 'low': 'ä½' };
        const urgencyZh = urgencyMap[stateData.issue.urgency] || stateData.issue.urgency;
        content = `
          <h3>è®®é¢˜ä¿¡æ¯</h3>
          <p><strong>æ ‡é¢˜ï¼š</strong>${stateData.issue.title}</p>
          <p><strong>æè¿°ï¼š</strong>${stateData.issue.description}</p>
          <p><strong>èƒŒæ™¯ï¼š</strong>${stateData.issue.background}</p>
          <p><strong>ç´§è¿«æ€§ï¼š</strong><span class="urgency-${stateData.issue.urgency}">${urgencyZh}</span></p>
          ${stateData.policy_card ? `
            <h3>åˆå§‹æ”¿ç­–å¡ç‰‡</h3>
            <p><strong>æ ‡é¢˜ï¼š</strong>${stateData.policy_card.title}</p>
            <p><strong>æ‘˜è¦ï¼š</strong>${stateData.policy_card.summary}</p>
            <p><strong>é¢„ç®—ï¼š</strong>${(stateData.policy_card.estimated_budget / 1e8).toFixed(2)} äº¿å…ƒ</p>
          ` : ''}
        `;
      } else if (stageId === 'departments_generate_memos') {
        content = '<h3>éƒ¨é—¨å¤‡å¿˜å½•</h3>';
        if (stateData.memos && stateData.memos.length > 0) {
          stateData.memos.forEach(memo => {
            const deptZh = departmentMap[memo.department] || memo.department;
            const positionZh = positionMap[memo.position] || memo.position;
            content += `
              <div class="memo-card">
                <h4>${deptZh}</h4>
                <p><strong>ç«‹åœºï¼š</strong><span class="position-${memo.position}">${positionZh}</span></p>
                <p><strong>ç†ç”±ï¼š</strong>${memo.rationale}</p>
                <p><strong>å…³åˆ‡ç‚¹ï¼š</strong>${memo.concerns.join('ã€')}</p>
              </div>
            `;
          });
        } else {
          content += '<p>æš‚æ— å¤‡å¿˜å½•æ•°æ®</p>';
        }
      } else if (stageId === 'secretariat_aggregate_disputes') {
        content = '<h3>æ±‡æ€»åˆ†æ­§</h3>';
        if (stateData.disputes && stateData.disputes.length > 0) {
          stateData.disputes.forEach(dispute => {
            const deptsZh = dispute.departments.map(d => departmentMap[d] || d).join('ã€');
            const severityZh = severityMap[dispute.severity] || dispute.severity;
            const statusZh = { 'unresolved': 'æœªè§£å†³', 'resolved': 'å·²è§£å†³', 'escalated': 'å·²å‡çº§' }[dispute.status] || dispute.status;
            content += `
              <div class="dispute-card severity-${dispute.severity}">
                <h4>${dispute.topic}</h4>
                <p><strong>æ¶‰åŠéƒ¨é—¨ï¼š</strong>${deptsZh}</p>
                <p><strong>ä¸¥é‡ç¨‹åº¦ï¼š</strong>${severityZh}</p>
                <p><strong>çŠ¶æ€ï¼š</strong>${statusZh}</p>
              </div>
            `;
          });
        } else {
          content += '<p>æš‚æ— åˆ†æ­§æ•°æ®</p>';
        }
      } else if (stageId === 'negotiation_rounds') {
        content = '<h3>è°ˆåˆ¤è½®æ¬¡</h3>';
        if (stateData.negotiation_history && stateData.negotiation_history.length > 0) {
          stateData.negotiation_history.forEach(round => {
            content += `
              <div class="negotiation-card">
                <h4>ç¬¬ ${round.round_number} è½®</h4>
                <p><strong>æ”¶æ•›åˆ†æ•°ï¼š</strong>${(round.convergence_score * 100).toFixed(1)}%</p>
                <p><strong>å¤„ç†åˆ†æ­§ï¼š</strong>${round.disputes_addressed.length} ä¸ª</p>
                <p><strong>å‰©ä½™åˆ†æ­§ï¼š</strong>${round.remaining_disputes.length} ä¸ª</p>
              </div>
            `;
          });
        } else {
          content += '<p>æš‚æ— è°ˆåˆ¤æ•°æ®</p>';
        }
      } else if (stageId === 'legal_review_gate' || stageId === 'fiscal_capacity_review_gate') {
        content = '<h3>é—¨ç¦å®¡æŸ¥ç»“æœ</h3>';
        const gate = stateData.gate_results?.find(g => g.gate_name.includes(stageId.split('_')[0]));
        if (gate) {
          content += `
            <div class="gate-card ${gate.passed ? 'gate-pass' : 'gate-fail'}">
              <h4>${gate.passed ? 'âœ… é€šè¿‡' : 'âŒ æœªé€šè¿‡'}</h4>
              <p><strong>å®¡æŸ¥é¡¹ï¼š</strong>${gate.gate_name}</p>
              ${gate.issues.length > 0 ? `<p><strong>é—®é¢˜ï¼š</strong>${gate.issues.join('ï¼›')}</p>` : ''}
              ${gate.recommendations.length > 0 ? `<p><strong>å»ºè®®ï¼š</strong>${gate.recommendations.join('ï¼›')}</p>` : ''}
            </div>
          `;
        } else {
          content += '<p>æš‚æ— é—¨ç¦æ•°æ®</p>';
        }
      } else if (stageId === 'decider_finalize') {
        content = '<h3>æœ€ç»ˆå†³ç­–</h3>';
        if (stateData.decision) {
          const dec = stateData.decision;
          content += `
            <div class="decision-card ${dec.approved ? 'decision-approved' : 'decision-rejected'}">
              <h4>${dec.approved ? 'âœ… æ‰¹å‡†' : 'âŒ ä¸æ‰¹å‡†'}</h4>
              <p><strong>å†³ç­–ç†ç”±ï¼š</strong>${dec.rationale}</p>
              <p><strong>æ”¿ç­–æ–‡æœ¬ï¼š</strong></p>
              <div class="policy-text-box">${dec.final_policy_text}</div>
              ${dec.conditions.length > 0 ? `<p><strong>é™„åŠ æ¡ä»¶ï¼š</strong>${dec.conditions.join('ï¼›')}</p>` : ''}
              ${dec.next_steps.length > 0 ? `<p><strong>ä¸‹ä¸€æ­¥ï¼š</strong>${dec.next_steps.join('ï¼›')}</p>` : ''}
            </div>
          `;
        } else {
          content += '<p>æš‚æ— å†³ç­–æ•°æ®</p>';
        }
      } else if (stageId === 'implementation_plan') {
        content = '<h3>æ‰§è¡Œè®¡åˆ’</h3>';
        const artifact = stateData.artifacts_index?.find(a => a.name === 'implementation_plan.txt');
        if (artifact) {
          content += `
            <p>æ‰§è¡Œè®¡åˆ’å·²ç”Ÿæˆ</p>
            <a href="/api/runs/{{ run_id }}/artifacts/${artifact.name}" target="_blank" class="btn-link">
              ğŸ“„ æŸ¥çœ‹æ‰§è¡Œè®¡åˆ’
            </a>
          `;
        } else {
          content += '<p>æ‰§è¡Œè®¡åˆ’å°šæœªç”Ÿæˆ</p>';
        }
      } else {
        content = '<p>è¯¥é˜¶æ®µæš‚æ— è¯¦ç»†ä¿¡æ¯</p>';
      }

      contentEl.innerHTML = content;
      section.style.display = 'block';
      section.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function closeStageDetails() {
      document.getElementById('stageDetailSection').style.display = 'none';
    }

    // æ£€æŸ¥è¿è¡ŒçŠ¶æ€ï¼Œå¦‚æœå·²å®Œæˆæˆ–å¤±è´¥ï¼Œä¸å»ºç«‹SSEè¿æ¥
    const runStatus = '{{ state.run_status }}';
    if (runStatus === 'completed' || runStatus === 'failed') {
      console.log('è¿è¡Œå·²ç»“æŸï¼Œä¸å»ºç«‹SSEè¿æ¥');
    } else {
      // SSE è¿æ¥ - ä»…åœ¨è¿è¡Œä¸­æ—¶å»ºç«‹
      const eventSource = new EventSource('/api/runs/{{ run_id }}/events');

      eventSource.addEventListener('stage_change', (e) => {
        const data = JSON.parse(e.data);
        const stageZh = stageMap[data.stage] || data.stage;
        document.getElementById('currentStage').textContent = stageZh;

        // æ›´æ–° stepper
        document.querySelectorAll('.step').forEach(step => {
          if (step.dataset.stage === data.stage) {
            step.classList.add('active');
          } else {
            step.classList.remove('active');
          }
        });

        addTimelineItem(data);
      });

      eventSource.addEventListener('memo_ready', (e) => {
        const data = JSON.parse(e.data);
        addTimelineItem(data);
        // å®é™…åº”ç”¨ä¸­å¯ä»¥åŠ¨æ€åˆ·æ–°å¤‡å¿˜å½•åˆ—è¡¨
      });

      eventSource.addEventListener('dispute_update', (e) => {
        const data = JSON.parse(e.data);
        addTimelineItem(data);
      });

      eventSource.addEventListener('negotiation_round', (e) => {
        const data = JSON.parse(e.data);
        addTimelineItem(data);
      });

      eventSource.addEventListener('tool_call', (e) => {
        const data = JSON.parse(e.data);
        addTimelineItem(data);
      });

      eventSource.addEventListener('gate_result', (e) => {
        const data = JSON.parse(e.data);
        addTimelineItem(data);
      });

      eventSource.addEventListener('decision', (e) => {
        const data = JSON.parse(e.data);
        addTimelineItem(data);
      });

      eventSource.addEventListener('completed', (e) => {
        document.getElementById('runStatus').textContent = statusMap['completed'];
        document.getElementById('runStatus').className = 'status-badge status-completed';
        addTimelineItem({
          timestamp: new Date().toISOString(),
          stage: 'completed',
          event_type: 'completed',
          message: 'âœ… å·¥ä½œæµå®Œæˆ'
        });
        eventSource.close();

        // ä¸è‡ªåŠ¨åˆ·æ–°é¡µé¢ï¼Œè®©ç”¨æˆ·æ‰‹åŠ¨æŸ¥çœ‹ç»“æœ
      });

      eventSource.addEventListener('error', (e) => {
        console.error('SSE error:', e);
        if (e.data) {
          const data = JSON.parse(e.data);
          document.getElementById('runStatus').textContent = statusMap['failed'];
          document.getElementById('runStatus').className = 'status-badge status-failed';
          addTimelineItem({
            timestamp: new Date().toISOString(),
            stage: 'error',
            event_type: 'error',
            message: 'âŒ ' + (data.error || 'æœªçŸ¥é”™è¯¯')
          });
        }
        eventSource.close();
      });

      function addTimelineItem(data) {
        const timeline = document.getElementById('timeline');
        const item = document.createElement('div');
        item.className = `timeline-item event-${data.event_type}`;

        const time = new Date(data.timestamp).toLocaleTimeString('zh-CN');
        const stageZh = stageMap[data.stage] || data.stage;
        
        // Agentä¿¡æ¯
        let agentBadge = '';
        if (data.agent_id) {
          const agentMap = {
            'agent_finance': 'ğŸ’° è´¢æ”¿éƒ¨',
            'agent_legal': 'âš–ï¸ æ³•åˆ¶åŠ',
            'agent_planning': 'ğŸ“‹ è§„åˆ’å±€',
            'agent_industry': 'ğŸ­ å·¥ä¿¡å±€',
            'agent_environment': 'ğŸŒ± ç¯ä¿å±€',
            'agent_security': 'ğŸ”’ å®‰å…¨å±€',
            'agent_office': 'ğŸ“ åŠå…¬å…',
            'agent_decider': 'ğŸ‘‘ å†³ç­–è€…'
          };
          const agentName = agentMap[data.agent_id] || data.agent_id;
          agentBadge = `<span class="agent-badge">${agentName}</span>`;
        }

        item.innerHTML = `
                <div class="timeline-time">${time}</div>
                <div class="timeline-content">
                    <strong>${stageZh}</strong>
                    ${agentBadge}
                    <p>${data.message}</p>
                </div>
            `;

        timeline.appendChild(item);
        timeline.scrollTop = timeline.scrollHeight;

        // æ›´æ–°äº‹ä»¶è®¡æ•°
        const count = parseInt(document.getElementById('eventCount').textContent) + 1;
        document.getElementById('eventCount').textContent = count;
      }

      // ç»“æŸSSEè¿æ¥çš„ifè¯­å¥
    }
  </script>
</body>

</html>