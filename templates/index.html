<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ”¿åºœéƒ¨é—¨å¤šæ™ºèƒ½ä½“å†³ç­–ä»¿çœŸç³»ç»Ÿ</title>
  <link rel="stylesheet" href="/static/style.css">
</head>

<body>
  {% set urgency_map = {
  "high": "é«˜",
  "medium": "ä¸­",
  "low": "ä½"
  } %}

  <div class="container">
    <header>
      <h1>ğŸ›ï¸ æ”¿åºœéƒ¨é—¨å¤šæ™ºèƒ½ä½“å†³ç­–ä»¿çœŸç³»ç»Ÿ</h1>
      <nav>
        <a href="/" class="active">æ–°å»ºä»¿çœŸ</a>
        <a href="/runs">å†å²è®°å½•</a>
        <a href="/setup">âš™ï¸ API é…ç½®</a>
      </nav>
    </header>

    <main>
      <section class="config-panel">
        <h2>é€‰æ‹©è®®é¢˜</h2>
        <form id="runForm">
          <div class="form-group">
            <label for="issueSelect">è®®é¢˜é€‰æ‹©</label>
            <select id="issueSelect" name="issue_select">
              <option value="">è¯·é€‰æ‹©è®®é¢˜...</option>
              {% for issue in issues %}
              <option value="{{ issue.id }}"
                data-title="{{ issue.policy_target }}"
                data-description="{{ issue.policy_target }}"
                data-urgency="{{ issue.urgency }}"
                data-sectors='{{ (issue.sectors or []) | tojson }}'>
                {{ issue.title }} [ç´§æ€¥åº¦: {{ urgency_map.get(issue.urgency, issue.urgency).upper() }}]
              </option>
              {% endfor %}
              
              <option value="custom">è‡ªå®šä¹‰è®®é¢˜...</option>
            </select>
          </div>

          <div id="customIssueFields" style="display: none;">
            <div class="form-group">
              <label for="customTitle">è®®é¢˜æ ‡é¢˜ <span style="color: red;">*</span></label>
              <input type="text" id="customTitle" placeholder="è¯·è¾“å…¥è®®é¢˜æ ‡é¢˜">
            </div>

            <div class="form-group">
              <label for="customDescription">è®®é¢˜æè¿° <span style="color: red;">*</span></label>
              <textarea id="customDescription" rows="3" placeholder="è¯·æè¿°è®®é¢˜çš„ä¸»è¦å†…å®¹..."></textarea>
            </div>

            <div class="form-group">
              <label for="customBackground">èƒŒæ™¯ä¿¡æ¯</label>
              <textarea id="customBackground" rows="3" placeholder="è¯·è¾“å…¥ç›¸å…³èƒŒæ™¯ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰"></textarea>
            </div>

            <div class="form-group">
              <label for="customUrgency">ç´§æ€¥ç¨‹åº¦</label>
              <select id="customUrgency">
                <option value="low">ä½</option>
                <option value="medium" selected>ä¸­</option>
                <option value="high">é«˜</option>
              </select>
            </div>
          </div>

          <h2 style="margin-top: 32px;">é…ç½®å‚æ•°</h2>

          <div class="form-group">
            <label for="maxRounds">æœ€å¤§è°ˆåˆ¤è½®æ¬¡</label>
            <input type="number" id="maxRounds" name="max_rounds" value="5" min="1" max="10">
          </div>

          <div class="form-group">
            <label for="threshold">æ”¶æ•›é˜ˆå€¼</label>
            <input type="number" id="threshold" name="convergence_threshold" value="0.15" min="0.05" max="0.5"
              step="0.05">
          </div>

          <div class="form-group">
            <label for="model">LLM æ¨¡å‹</label>
            <select id="model" name="model">
              <option value="qwen-plus">qwen-plusï¼ˆæ¨èï¼‰</option>
              <option value="qwen-max">qwen-maxï¼ˆé«˜çº§ï¼‰</option>
              <option value="qwen-turbo">qwen-turboï¼ˆå¿«é€Ÿï¼‰</option>
            </select>
          </div>

          <div class="form-group">
            <label for="temperature">é‡‡æ ·æ¸©åº¦</label>
            <input type="number" id="temperature" name="temperature" value="0.7" min="0" max="1" step="0.1">
          </div>

          <div class="form-group checkbox-group">
            <label>
              <input type="checkbox" id="enableSearch" name="enable_search">
              å¯ç”¨è”ç½‘æœç´¢
            </label>
          </div>

          <div class="form-group checkbox-group">
            <label>
              <input type="checkbox" id="enableOpinion" name="enable_public_opinion">
              å¯ç”¨èˆ†æƒ…æ¨¡æ‹Ÿ
            </label>
          </div>

          <button type="submit" class="btn-primary" id="submitBtn" disabled>
            å¼€å§‹ä»¿çœŸ
          </button>
        </form>
      </section>
    </main>
  </div>

  <script src="/static/app.js"></script>
  <script>
    const issueSelect = document.getElementById('issueSelect');
    const customIssueFields = document.getElementById('customIssueFields');
    const submitBtn = document.getElementById('submitBtn');

    // ç›‘å¬è®®é¢˜é€‰æ‹©å˜åŒ–
    issueSelect.addEventListener('change', (e) => {
      const value = e.target.value;

      if (value === 'custom') {
        customIssueFields.style.display = 'block';
        submitBtn.disabled = false;
      } else if (value) {
        customIssueFields.style.display = 'none';
        submitBtn.disabled = false;
      } else {
        customIssueFields.style.display = 'none';
        submitBtn.disabled = true;
      }
    });

    document.getElementById('runForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const formData = new FormData(e.target);
      const issueSelectValue = issueSelect.value;

      let config = {
        max_rounds: parseInt(formData.get('max_rounds')),
        convergence_threshold: parseFloat(formData.get('convergence_threshold')),
        model: formData.get('model'),
        temperature: parseFloat(formData.get('temperature')),
        enable_search: formData.get('enable_search') === 'on',
        enable_public_opinion: formData.get('enable_public_opinion') === 'on'
      };

      if (issueSelectValue === 'custom') {
        // è‡ªå®šä¹‰è®®é¢˜
        const title = document.getElementById('customTitle').value.trim();
        const description = document.getElementById('customDescription').value.trim();
        const background = document.getElementById('customBackground').value.trim();
        const urgency = document.getElementById('customUrgency').value;

        if (!title) {
          alert('è¯·è¾“å…¥è®®é¢˜æ ‡é¢˜');
          return;
        }
        if (!description) {
          alert('è¯·è¾“å…¥è®®é¢˜æè¿°');
          return;
        }

        config.custom_issue = {
          id: 'custom_' + Date.now(),
          title: title,
          description: description,
          background: background || 'ç”¨æˆ·è‡ªå®šä¹‰è®®é¢˜',
          urgency: urgency,
          sectors: ['é€šç”¨']
        };
      } else if (issueSelectValue) {
        // é¢„è®¾è®®é¢˜
        config.issue_id = issueSelectValue;
      } else {
        alert('è¯·é€‰æ‹©æˆ–è¾“å…¥è®®é¢˜');
        return;
      }

      submitBtn.disabled = true;
      submitBtn.textContent = 'æ­£åœ¨åˆ›å»º...';

      try {
        const response = await fetch('/api/runs', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(config)
        });

        if (response.ok) {
          const data = await response.json();
          window.location.href = `/runs/${data.run_id}`;
        } else {
          alert('åˆ›å»ºå¤±è´¥ï¼š' + await response.text());
          submitBtn.disabled = false;
          submitBtn.textContent = 'å¼€å§‹ä»¿çœŸ';
        }
      } catch (error) {
        alert('åˆ›å»ºå¤±è´¥ï¼š' + error.message);
        submitBtn.disabled = false;
        submitBtn.textContent = 'å¼€å§‹ä»¿çœŸ';
      }
    });
  </script>
</body>

</html>